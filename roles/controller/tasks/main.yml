---

- name: Set cmdline properties
  become: yes
  copy:
    src: cmdline.txt
    dest: /boot/cmdline.txt

- name: Install private SSH key
  copy:
    content: '{{ private_key }}'
    dest: "{{ '/home/' + pi_username + '/.ssh/id_rsa' }}"
    owner: "{{ pi_username }}"
    group: "{{ pi_username }}"
    mode: 0600
  no_log: yes
 
- name: Install public SSH key
  copy:
    content: '{{ public_key }}'
    dest: "{{ '/home/' + pi_username + '/.ssh/id_rsa.pub' }}"
    owner: "{{ pi_username }}"
    group: "{{ pi_username }}"
    mode: 0644
  no_log: yes

- name: Set hostname
  become: yes
  hostname:
    name: "{{ hostname }}"
    use: debian

- name: Set hostname in /etc/hosts
  become: yes
  lineinfile:
    path: /etc/hosts
    regexp: ^127\.0\.1\.1
    line: "{{ '127.0.1.1	' + hostname }}"

- name: Add clusterhat start script
  become: yes
  copy:
    src: clusterhat-start-nodes
    dest: /sbin/clusterhat-start-nodes
    owner: root
    group: root
    mode: 0755

- name: Add clusterhat node service
  become: yes
  copy:
    src: clusterhat-nodes.service
    dest: /etc/systemd/system/clusterhat-nodes.service
    owner: root
    group: root
    mode: 0644

- name: Enable clusterhat node service
  become: yes
  systemd:
    name: clusterhat-nodes
    state: started
    enabled: yes
    daemon_reload: yes

- name: Install packages
  become: yes
  apt:
    name: "{{ controller_packages }}"
    state: present    

- name: Add keychain to .bashrc
  lineinfile:
    create: yes
    path: "{{ '/home/' + pi_username + '/.bashrc' }}"
    line: eval `keychain --eval --agents ssh id_rsa`